// update-mod-version.js
// This script updates the ModVersion in boss-mode/info.txt to match the version in package.json

const fs = require("fs");
const path = require("path");

const pkgPath = path.join(__dirname, "package.json");
const infoPath = path.join(__dirname, "boss-mode", "info.txt");
const infoJsPath = path.join(__dirname, "src", "info.js");

const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));
const version = pkg.version;

let info = fs.readFileSync(infoPath, "utf8");

// Replace the ModVersion value (assumes it's a number or string)
info = info.replace(/("ModVersion"\s*:\s*)[^,\n]+/, `$1"${version}"`);

fs.writeFileSync(infoPath, info, "utf8");
console.log(`Updated ModVersion in info.txt to ${version}`);

// Also write all fields from info.txt to src/overlay/info.js as named exports
let infoObj;
try {
  infoObj = JSON.parse(info);
} catch (e) {
  // fallback: try to fix trailing commas or other issues
  infoObj = Function("return " + info)();
}

const jsLines = ["// This file is auto-generated by update-mod-version.js"];
for (const [key, value] of Object.entries(infoObj)) {
  // Convert key to a valid JS constant (e.g., ModVersion -> MOD_VERSION)
  const exportKey = key.replace(/([a-z])([A-Z])/g, "$1_$2").toUpperCase();
  jsLines.push(`export const ${exportKey} = ${JSON.stringify(value)};`);
}
jsLines.push("");
fs.writeFileSync(infoJsPath, jsLines.join("\n"), "utf8");
console.log(`Wrote all info.txt fields to src/info.js`);
